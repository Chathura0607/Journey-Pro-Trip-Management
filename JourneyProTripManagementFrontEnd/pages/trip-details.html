<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trip Details - Journey Pro</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f4;
            margin: 0;
            padding: 0;
        }

        .container {
            max-width: 900px;
            margin: 30px auto;
            padding: 25px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }

        h1, h2 {
            color: #28a745;
        }

        h1 {
            margin-bottom: 5px;
        }

        h2 {
            margin-top: 30px;
            margin-bottom: 15px;
            font-size: 1.5rem;
            border-bottom: 1px solid #e9ecef;
            padding-bottom: 10px;
        }

        .btn {
            display: inline-block;
            background-color: #28a745;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            text-decoration: none;
            font-size: 14px;
            margin-right: 10px;
        }

        .btn:hover {
            background-color: #218838;
        }

        .btn-secondary {
            background-color: #6c757d;
        }

        .btn-secondary:hover {
            background-color: #5a6268;
        }

        .btn-edit {
            background-color: #ffc107;
            color: #212529;
        }

        .btn-edit:hover {
            background-color: #e0a800;
        }

        .btn-delete {
            background-color: #dc3545;
        }

        .btn-delete:hover {
            background-color: #c82333;
        }

        .alert {
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px;
            display: none;
        }

        .alert-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-danger {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .nav-link {
            color: #28a745;
            text-decoration: none;
            margin-left: 15px;
        }

        .nav-link:hover {
            text-decoration: underline;
        }

        .trip-details {
            margin-bottom: 30px;
        }

        .trip-info {
            display: grid;
            grid-template-columns: 150px 1fr;
            gap: 10px;
            margin-bottom: 5px;
        }

        .label {
            font-weight: bold;
            color: #495057;
        }

        .value {
            color: #212529;
        }

        .status-badge {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 14px;
            font-weight: bold;
            margin-left: 10px;
        }

        .status-upcoming {
            background-color: #cff4fc;
            color: #055160;
        }

        .status-ongoing {
            background-color: #fff3cd;
            color: #664d03;
        }

        .status-completed {
            background-color: #d1e7dd;
            color: #0f5132;
        }

        .action-buttons {
            margin-top: 20px;
            display: flex;
        }

        .section {
            margin-bottom: 30px;
        }

        .no-data {
            color: #6c757d;
            font-style: italic;
            padding: 15px 0;
        }

        .card {
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #e9ecef;
        }

        .card-body .trip-info {
            margin-bottom: 5px;
        }

        .feedback-form {
            margin-top: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 4px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .form-group textarea, .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }

        .rating {
            display: flex;
            flex-direction: row-reverse;
            justify-content: flex-end;
        }

        .rating input {
            display: none;
        }

        .rating label {
            cursor: pointer;
            width: 30px;
            height: 30px;
            margin-right: 5px;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path d="M12 .587l3.668 7.568 8.332 1.151-6.064 5.828 1.48 8.279-7.416-3.967-7.417 3.967 1.481-8.279-6.064-5.828 8.332-1.151z" fill="lightgrey"/></svg>');
            background-repeat: no-repeat;
            background-position: center;
        }

        .rating input:checked ~ label {
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path d="M12 .587l3.668 7.568 8.332 1.151-6.064 5.828 1.48 8.279-7.416-3.967-7.417 3.967 1.481-8.279-6.064-5.828 8.332-1.151z" fill="gold"/></svg>');
        }

        .rating label:hover,
        .rating label:hover ~ label {
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path d="M12 .587l3.668 7.568 8.332 1.151-6.064 5.828 1.48 8.279-7.416-3.967-7.417 3.967 1.481-8.279-6.064-5.828 8.332-1.151z" fill="gold"/></svg>');
        }
    </style>
</head>
<body>
<div class="container">
    <div class="header">
        <h1>Trip Details</h1>
        <div>
            <a href="user-dashboard.html" class="nav-link">Dashboard</a>
            <a href="trip-list.html" class="nav-link">My Trips</a>
        </div>
    </div>

    <div id="successAlert" class="alert alert-success"></div>
    <div id="errorAlert" class="alert alert-danger"></div>

    <div id="tripDetailsContainer" class="trip-details">
        <div class="trip-info">
            <span class="label">Destination:</span>
            <span id="destination" class="value">Loading...</span>
        </div>
        <div class="trip-info">
            <span class="label">Start Date:</span>
            <span id="startDate" class="value">Loading...</span>
        </div>
        <div class="trip-info">
            <span class="label">End Date:</span>
            <span id="endDate" class="value">Loading...</span>
        </div>
        <div class="trip-info">
            <span class="label">Status:</span>
            <span id="status" class="value">Loading...</span>
        </div>

        <div class="action-buttons">
            <a id="editTripBtn" href="#" class="btn btn-edit">Edit Trip</a>
            <button id="deleteTripBtn" class="btn btn-delete">Delete Trip</button>
            <button id="addBookingBtn" class="btn">Add Booking</button>
        </div>
    </div>

    <h2>Bookings</h2>
    <div id="bookingsContainer" class="section">
        <div class="no-data">Loading bookings...</div>
    </div>

    <h2>Feedback</h2>
    <div id="feedbackContainer" class="section">
        <div id="existingFeedback"></div>
        <div id="feedbackForm" class="feedback-form">
            <h3>Add Your Feedback</h3>
            <form id="submitFeedbackForm">
                <div class="form-group">
                    <label>Rating</label>
                    <div class="rating">
                        <input type="radio" id="star5" name="rating" value="5" />
                        <label for="star5" title="5 stars"></label>
                        <input type="radio" id="star4" name="rating" value="4" />
                        <label for="star4" title="4 stars"></label>
                        <input type="radio" id="star3" name="rating" value="3" />
                        <label for="star3" title="3 stars"></label>
                        <input type="radio" id="star2" name="rating" value="2" />
                        <label for="star2" title="2 stars"></label>
                        <input type="radio" id="star1" name="rating" value="1" />
                        <label for="star1" title="1 star"></label>
                    </div>
                </div>
                <div class="form-group">
                    <label for="comment">Comment</label>
                    <textarea id="comment" name="comment" rows="4" required></textarea>
                </div>
                <button type="submit" class="btn">Submit Feedback</button>
            </form>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    $(document).ready(function() {
        // Check if user is logged in
        const token = localStorage.getItem('token');
        const role = localStorage.getItem('role');

        if (!token || role !== 'USER') {
            window.location.href = 'login.html';
            return;
        }

        // Get trip ID from URL
        const urlParams = new URLSearchParams(window.location.search);
        const tripId = urlParams.get('id');

        if (!tripId) {
            showError('Trip ID is missing');
            setTimeout(() => {
                window.location.href = 'trip-list.html';
            }, 2000);
            return;
        }

        // Get user ID (placeholder)
        let userId = localStorage.getItem('userId');
        if (!userId) {
            userId = "current-user";
        }

        // Load trip details
        loadTripDetails(tripId);

        // Load bookings for this trip
        loadBookings(tripId);

        // Load feedback for this trip
        loadFeedback(tripId);

        // Set up action buttons
        $('#editTripBtn').attr('href', `trip-edit.html?id=${tripId}`);

        $('#deleteTripBtn').on('click', function() {
            deleteTrip(tripId);
        });

        $('#addBookingBtn').on('click', function() {
            window.location.href = `booking-create.html?tripId=${tripId}`;
        });

        // Set up feedback submission
        $('#submitFeedbackForm').on('submit', function(e) {
            e.preventDefault();
            submitFeedback(tripId, userId);
        });

        function loadTripDetails(tripId) {
            const token = localStorage.getItem('token');

            // Debugging: Log the token and tripId
            console.log("Token:", token);
            console.log("Trip ID:", tripId);

            $.ajax({
                url: `http://localhost:8080/api/v1/user/trips/${tripId}`,
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                success: function(response) {
                    console.log("Response:", response);
                    if (response.code === 200) {
                        const trip = response.data;
                        const startDate = new Date(trip.startDate).toLocaleDateString();
                        const endDate = new Date(trip.endDate).toLocaleDateString();

                        $('#destination').text(trip.destination);
                        $('#startDate').text(startDate);
                        $('#endDate').text(endDate);

                        let statusClass = '';
                        switch(trip.status) {
                            case 'UPCOMING': statusClass = 'status-upcoming'; break;
                            case 'ONGOING': statusClass = 'status-ongoing'; break;
                            case 'COMPLETED': statusClass = 'status-completed'; break;
                        }

                        $('#status').html(`${trip.status} <span class="status-badge ${statusClass}">${trip.status}</span>`);
                    } else {
                        showError(response.message || 'Failed to load trip details');
                    }
                },
                error: function(xhr, status, error) {
                    console.error("AJAX Error:", status, error);
                    console.error("Response Text:", xhr.responseText);
                    showError('An error occurred while loading trip details. Please try again.');

                    // If unauthorized, redirect to login
                    if (xhr.status === 401 || xhr.status === 403) {
                        setTimeout(() => {
                            window.location.href = 'login.html';
                        }, 2000);
                    }
                }
            });
        }

        function loadBookings(tripId) {
            $.ajax({
                url: `http://localhost:8080/api/v1/user/bookings?userId=${userId}`,
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${token}`
                },
                success: function(response) {
                    if (response.code === 200) {
                        // Filter bookings for this trip
                        const bookings = response.data.filter(booking => booking.tripId === tripId);
                        displayBookings(bookings);
                    } else {
                        showError(response.message || 'Failed to load bookings');
                    }
                },
                error: function() {
                    showError('An error occurred while loading bookings');
                }
            });
        }

        function displayBookings(bookings) {
            let bookingsHTML = '';

            if (!bookings || bookings.length === 0) {
                bookingsHTML = `
            <div class="no-data">No bookings found for this trip.</div>
            <p>Click "Add Booking" to make a new booking for hotels, buses, or vehicles.</p>
        `;
            } else {
                bookings.forEach(booking => {
                    // Proper date formatting with fallback
                    const bookingDate = booking.createdAt ?
                        new Date(booking.createdAt).toLocaleDateString() :
                        'Not available';

                    // Get booking-specific details
                    let bookingDetails = '';
                    let specificName = 'Not specified';

                    if (booking.bookingType === 'HOTEL' && booking.hotelId) {
                        specificName = booking.hotelName || `Hotel ID: ${booking.hotelId}`;
                    }
                    else if (booking.bookingType === 'BUS' && booking.busId) {
                        specificName = booking.busNumber || `Bus ID: ${booking.busId}`;
                    }
                    else if (booking.bookingType === 'VEHICLE' && booking.vehicleId) {
                        specificName = booking.vehicleModel || `Vehicle ID: ${booking.vehicleId}`;
                    }

                    bookingDetails = `
                <div class="trip-info">
                    <span class="label">${booking.bookingType}:</span>
                    <span class="value">${specificName}</span>
                </div>
            `;

                    bookingsHTML += `
                <div class="card">
                    <div class="card-header">
                        <h3>${booking.bookingType} Booking</h3>
                        <span>Status: ${booking.status || 'CONFIRMED'}</span>
                    </div>
                    <div class="card-body">
                        ${bookingDetails}
                        <div class="trip-info">
                            <span class="label">Amount:</span>
                            <span class="value">$${booking.amount?.toFixed(2) || '0.00'}</span>
                        </div>
                        <div class="trip-info">
                            <span class="label">Booking Date:</span>
                            <span class="value">${bookingDate}</span>
                        </div>
                        <div style="margin-top: 10px;">
                            <a href="booking-details.html?id=${booking.id}" class="btn">View Details</a>
                            ${booking.status !== 'CANCELED' ?
                        `<button class="btn btn-delete cancel-booking" data-id="${booking.id}">Cancel Booking</button>` :
                        ''}
                        </div>
                    </div>
                </div>
            `;
                });
            }

            $('#bookingsContainer').html(bookingsHTML);
            $('.cancel-booking').on('click', function() {
                const bookingId = $(this).data('id');
                cancelBooking(bookingId);
            });
        }

        function loadFeedback(tripId) {
            $.ajax({
                url: `http://localhost:8080/api/v1/user/feedbacks?userId=${userId}`,
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${token}`
                },
                success: function(response) {
                    if (response.code === 200) {
                        // Filter feedback for this trip
                        const feedbacks = response.data.filter(feedback => feedback.tripId === tripId);
                        displayFeedback(feedbacks);
                    } else {
                        $('#existingFeedback').html('<div class="no-data">Failed to load feedback.</div>');
                    }
                },
                error: function() {
                    $('#existingFeedback').html('<div class="no-data">An error occurred while loading feedback.</div>');
                }
            });
        }

        function displayFeedback(feedbacks) {
            let feedbackHTML = '';

            if (!feedbacks || feedbacks.length === 0) {
                feedbackHTML = '<div class="no-data">No feedback submitted yet for this trip.</div>';
            } else {
                feedbackHTML = '<h3>Your Feedback</h3>';

                feedbacks.forEach(feedback => {
                    const stars = '★'.repeat(feedback.rating) + '☆'.repeat(5 - feedback.rating);
                    const feedbackDate = feedback.createdAt ?
                        new Date(feedback.createdAt).toLocaleDateString() :
                        'Date not available';

                    feedbackHTML += `
                <div class="card">
                    <div class="card-header">
                        <div style="color: gold; font-size: 20px;">${stars}</div>
                        <div>${feedbackDate}</div>
                    </div>
                    <div class="card-body">
                        <p>${feedback.comment || 'No comment provided'}</p>
                    </div>
                </div>
            `;
                });

                $('#feedbackForm').hide();
            }

            $('#existingFeedback').html(feedbackHTML);
        }

        function submitFeedback(tripId, userId) {
            const rating = $('input[name="rating"]:checked').val();
            if (!rating) {
                showError('Please select a rating');
                return;
            }

            const feedbackData = {
                userId: userId,
                tripId: tripId,
                rating: parseInt(rating),
                comment: $('#comment').val()
            };

            $.ajax({
                url: 'http://localhost:8080/api/v1/user/feedbacks',
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`
                },
                contentType: 'application/json',
                data: JSON.stringify(feedbackData),
                success: function(response) {
                    if (response.code === 201) {
                        showSuccess('Feedback submitted successfully');
                        $('#submitFeedbackForm')[0].reset();

                        // Reload feedback after short delay
                        setTimeout(function() {
                            loadFeedback(tripId);
                        }, 1000);
                    } else {
                        showError(response.message || 'Failed to submit feedback');
                    }
                },
                error: function() {
                    showError('An error occurred while submitting feedback');
                }
            });
        }

        function cancelBooking(bookingId) {
            if (confirm('Are you sure you want to cancel this booking?')) {
                $.ajax({
                    url: `http://localhost:8080/api/v1/user/bookings/${bookingId}/cancel`,
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    },
                    success: function(response) {
                        if (response.code === 200) {
                            showSuccess('Booking canceled successfully');

                            // Reload bookings after a delay
                            setTimeout(function() {
                                loadBookings(tripId);
                            }, 1000);
                        } else {
                            showError(response.message || 'Failed to cancel booking');
                        }
                    },
                    error: function() {
                        showError('An error occurred while canceling the booking');
                    }
                });
            }
        }

        function deleteTrip(tripId) {
            if (confirm('Are you sure you want to delete this trip? This will also delete all bookings associated with this trip.')) {
                $.ajax({
                    url: `http://localhost:8080/api/v1/user/trips/${tripId}`,
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    },
                    success: function(response) {
                        if (response.code === 200) {
                            showSuccess('Trip deleted successfully');

                            // Redirect to trip list after a delay
                            setTimeout(function() {
                                window.location.href = 'trip-list.html';
                            }, 2000);
                        } else {
                            showError(response.message || 'Failed to delete trip');
                        }
                    },
                    error: function() {
                        showError('An error occurred while deleting the trip');
                    }
                });
            }
        }

        function showSuccess(message) {
            $('#successAlert').text(message).show();
            $('#errorAlert').hide();

            // Auto-hide after 3 seconds
            setTimeout(function() {
                $('#successAlert').hide();
            }, 3000);
        }

        function showError(message) {
            $('#errorAlert').text(message).show();
            $('#successAlert').hide();
        }
    });
</script>
</body>
</html>